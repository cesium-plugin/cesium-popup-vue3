var M=Object.defineProperty;var x=(c,e,t)=>e in c?M(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var l=(c,e,t)=>(x(c,typeof e!="symbol"?e+"":e,t),t);import{r as k,h as D,o as g,c as w,a as v,t as P,_ as E,b as B,d as S,e as L}from"./index-2ba3296b.js";class H{constructor(e){l(this,"viewer");this.viewer=e}cartesian2ToCartesian3(e){const{viewer:t}=this;let i=null;if(t&&e){const a=this.viewer.scene.drillPick(e);let n=!1;for(const s in a)if(!Number.isNaN(Number(s))){const o=a[s];if(n=o&&o.primitive instanceof Cesium.Cesium3DTileFeature||o&&o.primitive instanceof Cesium.Cesium3DTileset||o&&o.primitive instanceof Cesium.Model,n&&(t.scene.pick(e),i=t.scene.pickPosition(e),i)){const r=Cesium.Cartographic.fromCartesian(i);r.height<0&&(r.height=0);const h=Cesium.Math.toDegrees(r.longitude),d=Cesium.Math.toDegrees(r.latitude),m=r.height;return i=this.lnglatToCartesian3(h,d,m),i}}if(!n)if(t.terrainProvider instanceof Cesium.EllipsoidTerrainProvider){if(i=t.scene.camera.pickEllipsoid(e,t.scene.globe.ellipsoid),i){const o=this.cartesian3ToLngLat(i);return o&&o.height<0&&(i=this.lnglatToCartesian3(o.longitude,o.latitude,.1)),i}}else{const o=t.scene.camera.getPickRay(e);return o?(i=t.scene.globe.pick(o,t.scene),i):null}}return i}cartesian2ToLnglat(e){const t=this.cartesian2ToCartesian3(e);return this.cartesian3ToLngLat(t)}cartesian3ToCartesian2(e){return Cesium.SceneTransforms.wgs84ToWindowCoordinates(this.viewer.scene,e)}computeViewerBounds(){const e=this.scene.camera.computeViewRectangle();let t=[];if(typeof e>"u"){const i=(o,r,h)=>{const{camera:d,scene:m}=o,C=new Cesium.Cartesian2(r,h),u=m.globe.ellipsoid,p=d.pickEllipsoid(C,u);if(p){const f=m.globe.ellipsoid.cartesianToCartographic(p),T=Cesium.Math.toDegrees(f.longitude),b=Cesium.Math.toDegrees(f.latitude);return{lon:T,lat:b}}},a=this.scene.canvas,n=i(this,0,0),s=i(this,a.clientWidth,a.clientHeight);n!=null&&n.lon&&(n!=null&&n.lat)&&(s!=null&&s.lon)&&(s!=null&&s.lat)&&(t=[n.lon,n.lat,s.lon,s.lat])}else t=[Cesium.Math.toDegrees(e.west),Cesium.Math.toDegrees(e.south),Cesium.Math.toDegrees(e.east),Cesium.Math.toDegrees(e.north)];return t}isVisibleByBounds(e){let t=!1;const i=this.computeViewerBounds();if(i){const a=this.cartesian3ToLngLat(e);if(a){const n=a.longitude,s=a.latitude;n>=i[0]&&n<=i[2]&&s>=i[1]&&s<=i[3]&&(t=!0)}}return t}cartesian3ToLngLat(e){if(e){const t=this.viewer.scene.globe.ellipsoid.cartesianToCartographic(e),i=Cesium.Math.toDegrees(t.latitude),a=Cesium.Math.toDegrees(t.longitude),n=t.height;return{longitude:a,latitude:i,height:n}}}}class I{constructor(e,t){l(this,"viewer");l(this,"element");l(this,"options");l(this,"cameraMoveEnd");l(this,"moving",!1);l(this,"postRender");l(this,"coord");var i;this.viewer=e,this.coord=new H(e),this.options=t,this.element=(i=this.options)==null?void 0:i.element,this.addCameraLisener(),this.addMapListener()}setPosition(e){var t,i,a;if(this.viewer&&e){const n=this.coord.cartesian3ToCartesian2(e),{element:s}=this;if(s&&n){let o=n.x-s.clientWidth/2,r=n.y-s.clientHeight-15;(t=this.options)!=null&&t.popPosition&&(((i=this.options)==null?void 0:i.popPosition)==="leftbottom"?(o=n.x,r=n.y-s.clientHeight):((a=this.options)==null?void 0:a.popPosition)==="leftmiddle"&&(o=n.x+20,r=n.y-s.clientHeight/2)),s.style.display="block",s.style.left=`${o}px`,s.style.top=`${r}px`}this.options&&(this.options.position=e)}}addCameraLisener(){var e,t;(e=this.options)!=null&&e.visibleMaxCameraHeight&&(this.cameraMoveEnd=(t=this.viewer)==null?void 0:t.camera.moveEnd.addEventListener(()=>{var n,s;const i=(n=this.viewer)==null?void 0:n.camera.getMagnitude(),a=6375e3;i&&((s=this.options)!=null&&s.visibleMaxCameraHeight)&&this.element&&(i-a>this.options.visibleMaxCameraHeight?this.hide():this.show())}))}hide(){this.element&&(this.element.style.visibility="hidden")}show(){this.element&&(this.element.style.visibility="visible")}destory(){this.cameraMoveEnd&&this.cameraMoveEnd(),this.postRender&&this.postRender()}addMapListener(){var e;this.postRender=(e=this.viewer)==null?void 0:e.scene.postRender.addEventListener(()=>{var i,a,n;const t=(i=this.options)==null?void 0:i.position;t&&((a=this.options)!=null&&a.renderInViewBounds?this.coord.isVisibleByBounds(t)?(this.moving||this.setPosition(t),((n=this.element)==null?void 0:n.style.visibility)!=="hidden"&&this.show()):this.hide():this.moving||this.setPosition(t))})}}class _{constructor(e,t){l(this,"viewer");l(this,"element");l(this,"popup");this.viewer=e,this.init(t)}init(e){const{component:t,position:i,popupCommonOption:a,props:n}=e,s=document.createElement("div");s.style.position="absolute",s.className="popup",this.element=s,t&&k(D(t,n),s),this.viewer.container.appendChild(s),this.popup=new I(this.viewer,{...a,element:s,position:i})}remove(){var e;this.element&&this.viewer.container.removeChild(this.element),(e=this.popup)==null||e.destory(),this.element=null}}const $={class:"test"},R=v("div",null," 我是测试弹窗vue3 ",-1),y={__name:"test2",props:["id","close"],setup(c){const e=c;function t(){e.close&&e.close()}return(i,a)=>(g(),w("div",$,[R,v("div",null," 这里写入弹窗内容:id="+P(e.id),1),v("div",{onClick:t}," 关闭 ")]))}};const V={__name:"cesium-map",setup(c){let e;const t=B(null);let i,a;function n(){const s="img",o="c",d=`http://{s}.tianditu.gov.cn/${`${s}_${o}`}/wmts?service=wmts&request=GetTile&version=1.0.0&LAYER=${s}&tileMatrixSet=${o}&TileMatrix={TileMatrix}&TileRow={TileRow}&TileCol={TileCol}&style=default&format=tiles&tk=4267820f43926eaf808d61dc07269beb`;return new Cesium.WebMapTileServiceImageryProvider({url:d,layer:s,style:"default",format:"tiles",tileMatrixSetID:o,subdomains:["t0","t1","t2","t3","t4","t5","t6","t7"],tilingScheme:new Cesium.GeographicTilingScheme,tileMatrixLabels:["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19"],maximumLevel:50})}return S(async()=>{if(t.value){e=new Cesium.Viewer(t.value,{baseLayer:Cesium.ImageryLayer.fromProviderAsync(n()),terrainProvider:await Cesium.CesiumTerrainProvider.fromUrl("http://data.mars3d.cn/terrain"),infoBox:!1,selectionIndicator:!1,animation:!1,timeline:!1,baseLayerPicker:!1});const{longitude:s,latitude:o,height:r}={height:66.31026938893555,latitude:28.143662686652874,longitude:113.62423548410626},h=Cesium.Cartesian3.fromDegrees(s,o,r),d=Cesium.Cartesian3.fromDegrees(113.6272273497165,28.143980467030072,71.92652572119125);e.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(s,o,1e3)});const{scene:m}=e;new Cesium.ScreenSpaceEventHandler(m.canvas).setInputAction(f=>{},Cesium.ScreenSpaceEventType.MIDDLE_CLICK);const u={component:y,position:h,props:{id:1,close:()=>{i.remove()}}};i=new _(e,u);const p={component:y,position:d,props:{id:2,close:()=>{a.remove()}}};a=new _(e,p)}}),(s,o)=>(g(),w("div",{ref_key:"mapRef",ref:t,class:"map"},null,512))}},N=E(V,[["__scopeId","data-v-9bf73c07"]]);const G={__name:"index",setup(c){return(e,t)=>(g(),L(N))}};export{G as default};
